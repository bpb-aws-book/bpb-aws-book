{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudFormation template for AWS Glue Crawler with S3 bucket and hourly schedule",
  "Resources": {
    "BookDataBucket": {
      "Type": "AWS::S3::Bucket"
    },
    "AthenaQueryResultsBucket": {
      "Type": "AWS::S3::Bucket"
    },
    "GlueDatabase": {
      "Type": "AWS::Glue::Database",
      "Properties": {
        "CatalogId": {
          "Ref": "AWS::AccountId"
        },
        "DatabaseInput": {
          "Name": {
            "Fn::Sub": "${AWS::StackName}_books_db"
          },
          "Description": "Database for books data"
        }
      }
    },
    "GlueCrawlerRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "glue.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole"
        ],
        "Policies": [
          {
            "PolicyName": "S3AccessPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "BookDataBucket",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::Sub": "${BookDataBucket.Arn}/*"
                    }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "BooksCrawler": {
      "Type": "AWS::Glue::Crawler",
      "Properties": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-books-crawler"
        },
        "Role": {
          "Fn::GetAtt": [
            "GlueCrawlerRole",
            "Arn"
          ]
        },
        "DatabaseName": {
          "Ref": "GlueDatabase"
        },
        "Targets": {
          "S3Targets": [
            {
              "Path": {
                "Fn::Sub": "s3://${BookDataBucket}/"
              }
            }
          ]
        },
        "Schedule": {
          "ScheduleExpression": "cron(0 * * * ? *)"
        },
        "SchemaChangePolicy": {
          "UpdateBehavior": "UPDATE_IN_DATABASE",
          "DeleteBehavior": "LOG"
        },
        "Configuration": "{\"Version\":1.0,\"CrawlerOutput\":{\"Partitions\":{\"AddOrUpdateBehavior\":\"InheritFromTable\"}}}"
      }
    },
    "AthenaWorkgroup": {
      "Type": "AWS::Athena::WorkGroup",
      "Properties": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-workgroup"
        },
        "Description": "Workgroup for querying book data",
        "State": "ENABLED",
        "RecursiveDeleteOption": true,
        "WorkGroupConfiguration": {
          "ResultConfiguration": {
            "OutputLocation": {
              "Fn::Sub": "s3://${AthenaQueryResultsBucket}/queryresults/"
            }
          },
          "EnforceWorkGroupConfiguration": true,
          "PublishCloudWatchMetricsEnabled": false
        }
      }
    }
  },
  "Outputs": {
    "BookDataBucket": {
      "Description": "Name of the S3 bucket for book data",
      "Value": {
        "Ref": "BookDataBucket"
      }
    },
    "AthenaQueryResultsBucketName": {
      "Description": "Name of the S3 bucket for Athena query results",
      "Value": {
        "Ref": "AthenaQueryResultsBucket"
      }
    },
    "DatabaseName": {
      "Description": "Name of the Glue database",
      "Value": {
        "Ref": "GlueDatabase"
      }
    },
    "CrawlerName": {
      "Description": "Name of the Glue crawler",
      "Value": {
        "Ref": "BooksCrawler"
      }
    },
    "CrawlerRoleArn": {
      "Description": "ARN of the Glue crawler role",
      "Value": {
        "Fn::GetAtt": [
          "GlueCrawlerRole",
          "Arn"
        ]
      }
    },
    "AthenaWorkgroupName": {
      "Description": "Name of the Athena workgroup",
      "Value": {
        "Ref": "AthenaWorkgroup"
      }
    },
    "AthenaQueryResultLocation": {
      "Description": "S3 location for Athena query results",
      "Value": {
        "Fn::Sub": "s3://${AthenaQueryResultsBucket}/queryresults/"
      }
    }
  }
}
